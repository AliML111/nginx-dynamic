load_module modules/ngx_http_js_module.so;
events {}
http {
    upstream site {
        zone   upstream_site 64k;
        hash $scheme$proxy_host$request_uri consistent;
        keepalive 65;
        server 192.168.0.130;
        #server 127.0.0.1:8081;
    }
    resolver  1.1.1.1 ipv6=off;
    resolver_timeout 5s;

    js_import /etc/nginx/njs/ingress.js;
    js_shared_dict_zone zone=proxy:512K;
    js_shared_dict_zone zone=count:512K type=number;


    js_set $upstream ingress.getUpstream;
    server {
      listen 80;
      

      location / {
        js_var $ingress_service "default-nginx1-80";
        js_var $upstreamFilePath "/etc/nginx/upstreams/";

        proxy_pass https://$upstream;
        
      }
      location /api/upstream {
          js_var $ingress_service "default-nginx1-80";
          js_var $upstreamFilePath "/etc/nginx/upstreams/";
          js_content ingress.handleUpstreamAPI;
      }
      
      location /otherlocation {
        set $ingress_service "rkatz-nginx2-80";
        proxy_pass http://$upstream;
      }
      location /otherlocation1 {
        proxy_pass http://$upstream;
      }
    }
}
